version: "3.7"
services:
  nginx:
    container_name: js-box-nginx
    image: nginx:latest
    restart: always
    env_file:
      - ./.env
    volumes:
      - ./nginx:/app/nginx/
      - ./logs/nginx:/app/logs
    ports:
      - "${JS_BOX_NGINX_PORT}:8000"
    expose:
      - ${JS_BOX_NGINX_PORT}
    environment:
      - NGINX_HOST=${JS_BOX_NGINX_HOST}
      - NGINX_PORT=8000
    command: /bin/bash -c "envsubst < /app/nginx/nginx-${JS_BOX_ENVIRONMENT}.conf > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
    depends_on:
      - client
      - api
    networks:
      - network
  client:
    container_name: js-box-client
    build:
      context: .
      dockerfile: .docker-client-${JS_BOX_CLIENT}-${JS_BOX_ENVIRONMENT}.dockerfile
    restart: always
    env_file:
      - ./.env
    environment:
      - NODE_ENV=${JS_BOX_ENVIRONMENT}
    volumes:
      - /app/client/node_modules
      - /app/client/build
      - ./client-${JS_BOX_CLIENT}:/app/client/
      - ./logs/client-${JS_BOX_CLIENT}:/app/logs
    depends_on:
      - api
    stdin_open: true
    networks:
      - network
  api:
    container_name: js-box-api
    build:
      context: .
      dockerfile: .docker-api-${JS_BOX_ENVIRONMENT}.dockerfile
    restart: always
    user: "node"
    env_file:
      - ./.env
    volumes:
      - /app/api/node_modules
      - ./api:/app/api/
      - ./logs/api:/app/logs
    privileged: true
    depends_on:
      - mongodb
    networks:
      - network
  mongodb:
    container_name: js-box-mongodb
    image: mongo:latest
    restart: always
    ports:
      - ${JS_BOX_MONGODB_PORT}:27017
    networks:
      - network
networks:
    network:
        driver: bridge
